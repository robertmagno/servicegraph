---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: onprem-k8s-agent-tme
spec:
  selector:
    matchLabels:
      app: onprem-k8s-agent-tme
      tier: backend
  replicas: 1
  template:
    metadata:
      labels:
        app: onprem-k8s-agent-tme
        tier: backend
    spec:
      containers:

        - name: onprem-k8s-agent-tme
          image: quay.io/citrix/adm-agent:latest
          imagePullPolicy: Always

          env:
          - name: IP
            value: onprem-k8s-agent-tme

          - name: APP_ID
            value: onprem-k8s-agent-tme

          - name: DEPL
            value: "service"

          - name: ORCH
            value: "Kubernetes"

          - name: MY_NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName

          - name: MY_POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: MY_POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          securityContext:
            capabilities:
              add:
               - NET_ADMIN

          ports:
            - name: http
              protocol: TCP
              containerPort: 80

            - name: https
              protocol: TCP
              containerPort: 443

            - name: lichb
              protocol: TCP
              containerPort: 27000

            - name: lic
              protocol: TCP
              containerPort: 7279
              
            - name: snmp
              protocol: UDP
              containerPort: 162
              
            - name: syslog
              protocol: UDP
              containerPort: 514

            - name: ipfix
              protocol: UDP
              containerPort: 4739

            - name: ulfd
              protocol: TCP
              containerPort: 5557

          volumeMounts:
            - name: secret-volume
              mountPath: /etc/adm_agent/secret
            - name: config-volume
              mountPath: /etc/adm_agent/config


      volumes:
        - name: secret-volume
          secret:
            secretName: onprem-k8s-agent-tme
        - name: config-volume
          configMap:
            name: onprem-k8s-agent-tme

---
apiVersion: v1
kind: Service
metadata:
  name: onprem-k8s-agent-tme
  labels:
    app: onprem-k8s-agent-tme
    tier: backend
spec:
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 80
    name: http
  - port: 443
    targetPort: 443
    name: https
  - port: 162
    targetPort: 162
    protocol: UDP
    name: snmp
  - port: 514
    targetPort: 514
    name: syslog
    protocol: UDP
  - port: 4739
    targetPort: 4739
    name: ipfix
    protocol: UDP
  - port: 5557
    targetPort: 5557
    name: ulfd
    protocol: TCP
  - port: 27000
    targetPort: 27000
    name: lichb
    protocol: TCP
  - port: 7279
    targetPort: 7279
    name: lic
    protocol: TCP
  selector:
    app: onprem-k8s-agent-tme
    tier: backend
---
kind: Secret
apiVersion: v1
metadata:
  name: onprem-k8s-agent-tme
data:
  db_key.conf: PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PGRic2VydmVya2V5PjxrZXk+QTIyNzM1Rjk5NzdENUY1RkU4OTk0Qjk3NTlDMjM1MUQ8L2tleT48L2Ric2VydmVya2V5Pg==
  private.pem: UEZKVFFVdGxlVlpoYkhWbFBqeE5iMlIxYkhWelBtZDVWV0p1YldWNlNHZ3ZjbU5zUWtKYWJHZHdObVZFV21wcGFteE5jVEkwZDJ4VVNXNUxiMlV2U1dsNFZHOHdVRk54VTFRcllsbFZOVzVQY210R1ZqRXphMEZuVTJKck9WTlNkMUp2UlZCSmIyZElXVlpDTUhoR1NHUnRkbEpRYWpsSWFHdDVhbThyYzNGMFoybDBVV2RhVGpsaVJURklXa055YjJ3eVJUbDZNR1l6ZEdKTGRYQkNSMUZwTmtKTk9YVkNjWFkyYjNsclFtUmpjMWRIUVZwNU5IZHRSRVp2TTFKSFVUUlJZM2xpTUdSNVNrcHdRbWxCYjJnM0syNTZjRmhUV0d4clpreFpNVGhIZFd3eU4wMXhNRXBqTDA5MVNYVllkQ3Q0VUdRNWFsaG9NVEV3UmpReVoxb3dibWxLTkZCNWRVOWpMM0F2VnlzMlpsTkRZVTluVFVwWFdYTnNZM1JEU0ZaUlpYUktVaXRwZFV4eGJsQmhOVXBaVFhseFVVWlBTMmhWTmtWUmNIQTNVR0k1TWtScU1sTlBUREJSWTJvd1pHbE1WMnRSWjBwWlUyTnhWRXB3U0RkWFdsUjBNVEJSUm5wTlVUMDlQQzlOYjJSMWJIVnpQanhGZUhCdmJtVnVkRDVCVVVGQ1BDOUZlSEJ2Ym1WdWRENDhVRDR6V0hWWWVXOVpiVVZYTlVORU1sVnFZWFI1T0VkaE5XTlNTWHA2ZGxZMmR6UnNibkFyU20xYWNERnFaVUY1WTJwWmNWUlhRbmh5VkVKM2FtdEhXVTFYZVhSRWFteGFkQ3Q1UTFWb1NIVTFhWGhRTlZZMGNEUlhOMUJrWmtWQlVVRTNMMmx6WlZSWkwydFBOVTVHZGpoUWQzRkljRkkzWXl0RldHWXljSGxzZWpsV2RuZHplRXR3Ymk5WWNuVkpaWEJTVUc1QmJXOU5lRVo0TkVrelYzZHFiV1pzVldoRVVFWmlNMk05UEM5UVBqeFJQbXcxVmxsQ1RVY3dlVFJNUm5RMGVuTnNWMkV5UVRWeWVGRTRTSGh5Ykdwb1dsSlZVMEY2UjFBeWVEZFJibHBsVUROdE5IVjNUa0YzWlU1allsUldNVWxNVEd4SU9HOUtNRnBaVEcwNWRWcGFPSGhQYUVsRWRWaHpXRE5FS3pCaVVGTTJTbkpzWkdObVNuVkVTMlYxUjNoSGNHVmhORXcyZVRod2NHRlJkV2xhWXpZNVJYRnJObW81U0ZRclltdzNVVEJ1TUhseWN5dEVhMEU1TkdwRFRsWm1hVkZoYTNKS1RqZEtZejA4TDFFK1BFUlFQbFU0Vm5ablJHRkdTalJ4WjJsa2IycE1NRkZYUlZaRFZuSlpabmx0VDIwM01XRkdWV3RoWW01TGVHazVkMFYxU2xselNXVkJZMjUyYWpOWFdtTk9lbGxRYUZsTlVHOVlNWGxvV0doR1UxaDBWR0l3TVVaMVdHTnVabmhwYUVabkwxVnZVMjlHTmtOb1NXeDNMelZFWWswMmVubzJWWGh1U0RkRGRVaHhNbkJQV21KMFJYRjZZV1l5WkZSWFRqVkdORkZLUzBkbGRYRnpTWEZhUm1wQ2NHVjZUbTh4VlZaMVZHcGlhejA4TDBSUVBqeEVVVDVqS3l0M2N6SnhiMkZwVFhGTUwyOXJSbEo2UzNnM1ZXaEtTemRaZERNeVdsaDFUMlowUkhWaVEwZ3ZiMFpVUTFCNFFrNUllRkZqTW0wMldVTmFjMmxoTlVWSlRqWnJhVzB4SzBWdU16a3hUa2hQU2psclVtRnFUR2RwTHpsYVkzbEJNbkJHYlZGU1FTdHJOV2czTVhob1VtSkxRWEppWVU1VVdYRkxNRXhRZDJObkszbHRRVTkyTWs1QlIzSmpiblJOTmtNMFVFRllVbGhWVkVnNFdEaDNOakZ4V0hwSE1UbDBhRGc5UEM5RVVUNDhTVzUyWlhKelpWRStUMGhQYUVWM1ZHRmFiV1F4VlZSVmRqVnlORlJUVEUxRVdYQTBhR3RFYkZsNmRVY3hkR1F6YWpoME1FbG9ia1pWWVdGTFlsZ3pLemRuYTJZNVpYTkRUbXAxV25vMVduQnJVSGhLYkRaek4zaDBNVTU1TmpBd2JFYzVUMnh4TjNsQlkyNVJaRmwyTURGNmFTOVZZbk4yTkZaWE1qWktWRFZFYkc1ek9ETk5kMjlhWW5FeU5EaFpSalpaTjFSblJGWnVWbTlYU3pkalEyNDBVMFZ1YjJNMGNrZDNVbTV6Y1hsbFYxTkpQVHd2U1c1MlpYSnpaVkUrUEVRK1NYWjNhMDlSWVRZM2NqbG1TbEJwY0RaaE5UbFNLMjR5ZGpScVJGVTVhWEZKUWxaVlEzYzRURUY0TVVsQ05HUjZNamx4TlhGMlZHRTRTSFJOSzJzd1EwTTBPRnA2WmtRdmJUSkNSV2d6WkhSeU1rcEZibTVRU0VsM2JWUlBOemw0YjFWaU5IaEZXSHBqWlVKeUsySXdURUY2TTJWWmRrbEVjakoyYmt0eFVsQmFiV0ZUUkhSd1oxWlZOazVVVmtoTmRHazVVVmhKWVRKUWRWTmxOMDVvSzB0VFIzcERUSEZOV1dNM2FTdFZZamwyV21OcGNFbHNWSEpJYjI1eWNsaFFjVlFyWmpaWlNrMWhWR2xqUlZaMFNIY3pRamswZFhSVWFUQkJaSHBVYms1SlNrTktRMVJRZWpkaFEzcHhhamRITkcxWVV6Rk1WbEJXTkZOR2FFcDJPR0ZyTjBaVmVqRTJTRVpzY2xoMWFXTmpVRGxoTTFSWU5pdDFlRlpJVVVrMlVrWnNOazVRUlRONVdYaGpVREV2YjBJMFYxUnFZMFJrTW5aRmFFUkViWGhNT1d0b2NqWnFNMDlqVWpGa1ZuWmpkV3hzV0dwUlBUMDhMMFErUEM5U1UwRkxaWGxXWVd4MVpUND0=
  public.pem: UEZKVFFVdGxlVlpoYkhWbFBqeE5iMlIxYkhWelBtZDVWV0p1YldWNlNHZ3ZjbU5zUWtKYWJHZHdObVZFV21wcGFteE5jVEkwZDJ4VVNXNUxiMlV2U1dsNFZHOHdVRk54VTFRcllsbFZOVzVQY210R1ZqRXphMEZuVTJKck9WTlNkMUp2UlZCSmIyZElXVlpDTUhoR1NHUnRkbEpRYWpsSWFHdDVhbThyYzNGMFoybDBVV2RhVGpsaVJURklXa055YjJ3eVJUbDZNR1l6ZEdKTGRYQkNSMUZwTmtKTk9YVkNjWFkyYjNsclFtUmpjMWRIUVZwNU5IZHRSRVp2TTFKSFVUUlJZM2xpTUdSNVNrcHdRbWxCYjJnM0syNTZjRmhUV0d4clpreFpNVGhIZFd3eU4wMXhNRXBqTDA5MVNYVllkQ3Q0VUdRNWFsaG9NVEV3UmpReVoxb3dibWxLTkZCNWRVOWpMM0F2VnlzMlpsTkRZVTluVFVwWFdYTnNZM1JEU0ZaUlpYUktVaXRwZFV4eGJsQmhOVXBaVFhseFVVWlBTMmhWTmtWUmNIQTNVR0k1TWtScU1sTlBUREJSWTJvd1pHbE1WMnRSWjBwWlUyTnhWRXB3U0RkWFdsUjBNVEJSUm5wTlVUMDlQQzlOYjJSMWJIVnpQanhGZUhCdmJtVnVkRDVCVVVGQ1BDOUZlSEJ2Ym1WdWRENDhMMUpUUVV0bGVWWmhiSFZsUGc9PQ==
  password: MmU5MjE4MTIyNWNlYWRhZGIxYjRhMDBjYmFjODcyODk4NGJkY2ZhYzYxY2IzNzQwMWNiYTI2NzU4MTY1MWNkNQ==
---
kind: ConfigMap 
apiVersion: v1 
metadata:
  name: onprem-k8s-agent-tme
data:
  agent.conf: |
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <mps_agent>
    <uuid>#uuid</uuid>
    <url>railay.agent.adm.cloud.com</url>
    <customerid>90b755d560e2dfe68c2cb3d4f5d4cf6a8ebdad4a287612f0e929592504e47579</customerid>
    <instanceid>4104170c1754e8f72a81cab7b8196b8c113f261d990c43dc26656d0c2698f0fff2ecc997d3be30b1b2f75ead1bd7143810048dd5e7427fee75b672ed4a68b50b</instanceid>
    <servicename>85888ae8be0f8735bd7a681cb304d20500d7f58687e1c69cb4839e8c9a59c498</servicename>
    <download_service_url>download.citrixnetworkapi.net</download_service_url>
    <abdp_url>railay.agent.adm.cloud.com</abdp_url>
    <msg_router_url>railay.agent.adm.cloud.com</msg_router_url>
    </mps_agent>
  proxy.conf: |
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <proxy>
    <proxy_server_ip>#proxy_server_ip</proxy_server_ip>
    <proxy_user>#proxy_server_username</proxy_user>
    <proxy_password>#proxy_server_password</proxy_password>
    <proxy_server_port>#proxy_server_port</proxy_server_port>
    </proxy>
